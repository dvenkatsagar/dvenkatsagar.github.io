---
layout:     post
title:      How to download dynamically loaded content using python
date:       2015-10-26 22:52:20
summary:    A small tip on how you can download videos or files that are dynamically loaded in a website using python.
categories:
 - tutorials
 - python
author:     Sagar D.V
thumbnail:  cloud-download
tags:
 - Python
 - Selenium Web-Driver
 - PhantomJS
 - Wget
---

## Introduction

When you surf online, you occasionally visit websites that show content like videos or audio files which are dynamically loaded. This is basically done using AJAX calls or sessions where the URLs for these files are generated in some way for which you can not save them by normal means. A scenario would be like, for example, you visited a web page and a video is loaded through a video player like jwplayer after 1 or 2 secs. You want to save this but unfortunately you couldn't do so by right-clicking on it and saving it as the player doesn't show that option. Even if you use command line tool like [wget](https://www.gnu.org/software/wget/) or [youtube-dl](https://rg3.github.io/youtube-dl/), it might be possible but for some reason it just doesn't work. Now the question is, how would you download such files to your computer?

Well, there are different ways to download them. One way is to use a plugin or extension for the browser like [Grab Any Media](http://grabanymedia.altervista.org/) or [FlashGot](https://flashgot.net/) which can handle such requests and might allow you to download it. Now the thing is, lets say you want to download an entire set of videos that are loaded using different AJAX calls. In this case, the plugins or extensions, might work but it takes a long time to manually download each file. A better method would be to create a small script that automates this process. This tutorial aims to teach you guys on how to use the selenium web driver and do simple tasks like downloading dynamically loaded content in a website using python.

## Prerequisites

For this tutorial, you need to have atleast some knowledge on how to program in python. If you don't know anything about python, then I would suggest you to check out this site : [http://www.tutorialspoint.com/python/](http://www.tutorialspoint.com/python/). It is a great starting point to learn a new language and its easy to understand.

So, before we start, I would like to give an small introduction to the modules that I am going to use in my python script. The system that I'm using is a Ubuntu Studio 14.04 and in order to install the modules using python-pip, you might need to have administrative privileges. Here are the modules as follows :

- [Selenium Web Driver](http://www.seleniumhq.org/projects/webdriver/) : The selenium framework is a suite of tools that can be used to test web applications and also automate the web browser tasks. By using it's provided API, you can do simple tasks like automating administration work for a website or some website-related maintenance, by sending commands to the browser. It supports various programming languages like Python, Java, Javascript, PHP, C#, Perl, Ruby. To install this framework for python, just type the following command in the terminal :

```bash
pip install selenium
```

- [BeautifulSoup](http://www.crummy.com/software/BeautifulSoup/) : The bs4 is a HTML/XML parser that does a great job at screen-scraping elements and getting information like the tag names, attributes and values. It also has set of methods that allow you do things like, to match certain instances of a text and retrieve all the elements that contain it. To install this python module, type the following command in the terminal :

```bash
pip install beautifulsoup4
```

- [Python-Wget](https://pypi.python.org/pypi/wget) : This module is a python port for the wget command-line program. Its easy to setup and you can quickly download videos or files to your system by using it API. You can follow the "traditional" method of downloading files like using the standard `urllib` module or by doing a subprocess call to the wget command-line program, but for this tutorial, I will be using this module to get the job done. To install it to your system, type the following command in the terminal :

```bash
pip install wget
```

- [PhantomJS](http://phantomjs.org/) (Optional) : The PhantomJS is a headless browser (doesn't have a front-end GUI and everything works at the backend) that is used for web page interaction. It is similar to the selenium web driver but the difference is that, it is headless. For this tutorial, I will be using the basic Firefox web driver via selenium, but you can test this out if you do not want a browser to popup every time the script runs. You can download the phantomjs executable from their homepage, but I advice you to use a downgraded version of this as the latest one might not be compatible with selenium module.

## The Concept

The idea is basically to get the webpage using the selenium web driver, parse and extract the video or audio urls from the html page using BeautifulSoup, and finally download the files to the system using wget.

## Step 1

The first step we need to do is import the necessary modules in the python script or shell, and this can be done as shown below :

```python
# The standard library modules
import os
import sys

# The wget module
import wget

# The BeautifulSoup module
from bs4 import BeautifulSoup

# The selenium module
from selenium import webdriver
from selenium.webdriver.common.keys import Keys
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.by import By
```

From the selenium module, we import the following things :

- **webdriver** : This submodule has the functionality to call the various browsers like Chrome, Firefox, IE, etc.
- **Keys** : This allows us to send key presses to the webdriver.
- **WebDriverWait** : The WebDriverWait is similar to the sleep function of the `time` module. This function tells the webdriver to wait for n seconds.
- **expected_conditions** : There are common conditions that the webdriver takes into account like, for example, a condition would be for an element to appears in the browser or when the title of the page is *somename*. Here is a list of all the available conditions [^1] :
  - title_is
  - title_contains
  - presence_of_element_located
  - visibility_of_element_located
  - visibility_of
  - presence_of_all_elements_located
  - text_to_be_present_in_element
  - text_to_be_present_in_element_value
  - frame_to_be_available_and_switch_to_it
  - invisibility_of_element_located
  - element_to_be_clickable - it is Displayed and Enabled.
  - staleness_of
  - element_to_be_selected
  - element_located_to_be_selected
  - element_selection_state_to_be
  - element_located_selection_state_to_be
  - alert_is_present
- **By** : The By class allows us to select elements in the webdriver by classname, id, xpath, name, hyperlinks, etc.

## Step 2

Now, according to the concept, for a single video url that is loaded using an AJAX call, we need to get the web page using the selenium webdriver. This is done as follows :

```python
driver = webdriver.Firefox() # if you want to use chrome, replace Firefox() with Chrome()
driver.get("http://www.example.com") # load the web page
```

When you execute this in the python shell or via the script (after you import the modules), you will observe that, a firefox browser will popup and a page will be loaded into it. If you want to use the PhantomJS and stop the browser from popping up, then just replace the `webdriver.Firefox()` with `webdriver.PhantomJS(service_args=['--ignore-ssl-errors=true'])`

## Step 3

Here is the tricky part, what you need to do is extract the video urls from the web page. As every website is designed differently, you don't have an accurate solution. You would need to manually check for a pattern or the video element that is dynamically loaded. This can be done by looking at the browser console. From the previously mentioned scenario, lets say the video is dynamically loaded after 1 sec you visit the website. Then you would need to wait till the video is loaded and then get the element, so for that you can write the script in this manner :

```python
WebDriverWait(driver, 50).until(EC.visibility_of_element_located((By.ID, "the-element-id"))) # waits till the element with the specific id appears
src = driver.page_source # gets the html source of the page
```

When you execute these two lines in the python shell, it will tell the browser to wait for 50 seconds by default until the element with the specific id appears or is visible, and then get the html source. Now if the element doesn't have an ID, there are other ways you can get the specific element/tag. Lets say the element has a certain class, then you can just replace the `By.ID` with `By.CLASS_NAME`. Here is the entire list of attributes for the `By` class object [^2] :

- ID
- XPATH
- LINK_TEXT
- PARTIAL_LINK_TEXT
- NAME
- TAG_NAME
- CLASS_NAME
- CSS_SELECTOR

## Step 4

Once you get the HTML source, you would need to parse it and extract the video tag from it. This is done like this :

```python
parser = BeautifulSoup(src,"lxml") # initialize the parser and parse the source src
list_of_attributes = {"class" : "some-class", "name" : "some-name"}
tag = parser.findAll('video',attrs=list_of_attributes) # Get the video tag from the source
```

The `list_of_attributes` is a python dictionary, with (key,value) pairs which specify the video tags attributes.

## Step 5

The next step is, get the url from the video tag and finally download it using wget. This is done as shown below :

```python
url = tag[0]['src'] # get the src attribute of the video
wget.download(url,out="path/to/output/file") # download the video
```

## References

[^1]: [http://selenium-python.readthedocs.org/waits.html#explicit-waits](http://selenium-python.readthedocs.org/waits.html#explicit-waits)
[^2]: [http://selenium-python.readthedocs.org/locating-elements.html](http://selenium-python.readthedocs.org/locating-elements.html)
